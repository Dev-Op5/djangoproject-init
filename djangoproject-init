#!/usr/bin/env bash
set -euo pipefail

# ==============================================
# djangoproject-init
# Bootstrap Django development project
# 
# scripted with ❤️ by eRQee (q@serverq.org)
# ==============================================

SCRIPT_NAME="$(basename "$0")"
DEFAULT_DJANGO_MAJOR=6
DRY_RUN=false

TIMESTAMP="$(date '+%Y-%m-%d %H:%M:%S')"
LOG_FILE="logs/bash_history.log"

print_help() {
cat << 'EOF'
djangoproject-init — bootstrap Django development project

Usage:
  djangoproject-init [VERSION] [TARGET_DIR] [--dry-run]

Arguments:
  VERSION        Optional Django version selector:
                 - 6        -> Django >=6.0,<7.0
                 - 6.0      -> Django >=6.0,<6.1
                 - (none)   -> Django >=6.0,<7.0 (default)

  TARGET_DIR     Optional target directory:
                 - folder   -> create & use folder
                 - .        -> use current directory
                 - (none)   -> use current directory

Options:
  --dry-run      Print actions without executing
  --help         Show this help message

Examples:
  djangoproject-init
  djangoproject-init 6
  djangoproject-init 6.0 folder_project
  djangoproject-init 6 --dry-run
EOF
}

run() {
    if [[ "$DRY_RUN" == true ]]; then
        echo "[dry-run] $*"
    else
        eval "$@"
        echo "$@" >> "$LOG_FILE"
    fi
}

# -------------------------
# Argument parsing
# -------------------------
DJANGO_VERSION_ARG=""
TARGET_DIR="."

for arg in "$@"; do
    case "$arg" in
        --help)
            print_help
            exit 0
            ;;
        --dry-run)
            DRY_RUN=true
            ;;
        *)
            if [[ -z "$DJANGO_VERSION_ARG" ]]; then
                DJANGO_VERSION_ARG="$arg"
            else
                TARGET_DIR="$arg"
            fi
            ;;
    esac
done

# -------------------------
# Django version resolution
# -------------------------
if [[ -z "$DJANGO_VERSION_ARG" ]]; then
    DJANGO_SPEC="Django>=${DEFAULT_DJANGO_MAJOR}.0,<$((${DEFAULT_DJANGO_MAJOR}+1)).0"
elif [[ "$DJANGO_VERSION_ARG" =~ ^[0-9]+$ ]]; then
    DJANGO_SPEC="Django>=${DJANGO_VERSION_ARG}.0,<$((${DJANGO_VERSION_ARG}+1)).0"
elif [[ "$DJANGO_VERSION_ARG" =~ ^[0-9]+\.[0-9]+$ ]]; then
    MAJOR="${DJANGO_VERSION_ARG%%.*}"
    MINOR="${DJANGO_VERSION_ARG##*.}"
    DJANGO_SPEC="Django>=${MAJOR}.${MINOR},<${MAJOR}.$((MINOR+1))"
else
    echo "❌ Invalid Django version: $DJANGO_VERSION_ARG"
    exit 2
fi

echo "==> Using $DJANGO_SPEC"

# -------------------------
# Target directory handling
# -------------------------
if [[ "$TARGET_DIR" != "." ]]; then
    mkdir -p "$TARGET_DIR"
    cd "$TARGET_DIR"
fi

# Directory must be empty
if [[ -n "$(ls -A . 2>/dev/null)" ]]; then
    echo "❌ Target directory is not empty: $(pwd)"
    exit 3
fi

# -------------------------
# Bootstrap process
# -------------------------
if [[ "$DRY_RUN" == false ]]; then
    mkdir -p logs
    {
        echo "======================================================================"
        echo " djangoproject-init run at [$TIMESTAMP]"
        echo "======================================================================"
    } >> "$LOG_FILE"
fi


run "mkdir -p backup backup/routines logs server.conf/certs scripts"
run "touch logs/.gitkeep server.conf/.gitkeep server.conf/certs/.gitkeep scripts/.gitkeep backup/routines/.gitkeep"

run "python -m venv .venv"

run "curl -fsSL https://raw.githubusercontent.com/Dev-Op5/djangoproject-init/refs/heads/master/manage -o /tmp/manage"
run "chmod +x /tmp/manage"
run "mv /tmp/manage .venv/bin/manage"

run "source .venv/bin/activate"
run "python -m pip install --upgrade pip"
run "python -m pip install \"$DJANGO_SPEC\" django-stubs django-stubs-ext python-decouple "


# Defaults file
# Create backup/restore configuration file
run "cat > backup/db.conf.example << EOL
db_host = localhost
db_port = 5432
db_user = postgres
db_pass = changeme
db_name = yourdatabasename
EOL"

run "cat > backup/README.md << EOL
Backup/Restore in this folder is specific to PostgreSQL using the CLI 'pg-execute'.
Source: https://github.com/Dev-Op5/pg-execute/

Quick installation:
curl -fsSL https://raw.githubusercontent.com/Dev-Op5/pg-execute/master/pg-execute -o /tmp/pg-execute
chmod +x /tmp/pg-execute
sudo mv /tmp/pg-execute /usr/local/bin

CLI usage test example:
1. Run the command: 'pg-execute generate-config' to generate the db.conf file.
2. Adjust the connection variables in the db.conf file based on your DB settings.
3. In the 'backup' folder, test by running the command: 'pg-execute login'

If you can enter the psql console, then it works!
EOL"

run "curl -fsSL https://raw.githubusercontent.com/Dev-Op5/pg-execute/master/pg-execute -o /tmp/pg-execute"
run "chmod +x /tmp/pg-execute"
run "mv /tmp/pg-execute .venv/bin/pg-execute"

# Create template for nginx reverse proxy
if [[ "$DRY_RUN" == true ]]; then
run "echo 'create nginx reverse proxy configuration template in server.conf/nginx.local.example'"
else

cat > server.conf/nginx.local.example << 'EOL'
server {
  listen                     80;
  server_name                example.local;
  return 301                 https://$server_name$request_uri;
}

server {
  listen                     443 ssl;
  http2                      on;
  server_name                example.local;
EOL

CURRENT_DIR=$(pwd)
cat >> server.conf/nginx.local.example << EOL
  access_log                 ${CURRENT_DIR}/logs/access.log gzip;
  error_log                  ${CURRENT_DIR}/logs/error.log notice;

  ssl_certificate            ${CURRENT_DIR}/server.conf/certs/example.local.pem;
  ssl_certificate_key        ${CURRENT_DIR}/server.conf/certs/example.local-key.pem;
  include                    /etc/nginx/snippets/ssl-params.conf;
  include                    /etc/nginx/snippets/headers.conf;

  root                       ${CURRENT_DIR};
EOL

cat >> server.conf/nginx.local.example << 'EOL'
  location / {
    proxy_pass               http://127.0.0.1:8000;
    error_page               502 = /502.html;
    proxy_set_header         Host $host;
    proxy_set_header         X-Real-IP $remote_addr;
    proxy_set_header         X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header         X-Forwarded-Proto $scheme;
    send_timeout             60;
    client_max_body_size     100M;
    client_body_buffer_size  100M;
  }
}
EOL

fi

# Repo-level gitignore
run "cat > .gitignore << 'EOL'
.env
.venv/
backup/db.conf
backup/*.7z
logs/*.log
server.conf/nginx.live.conf
server.conf/nginx.local
EOL"

# Django project
run ".venv/bin/django-admin startproject workspace"

# Project-level gitignore
run "cat > workspace/.gitignore << 'EOL'
__pycache__/
*.py[cod]
db.sqlite3
*.log
.vscode/
.idea/
.coverage
htmlcov/
.pytest_cache/
.DS_Store
Thumbs.db
EOL"

# default .env.example
run "cat > workspace/.env.example << 'EOL'
DEBUG=True
SECRET_KEY=changeme
ALLOWED_HOSTS=localhost,127.0.0.1
DATABASE_URL=postgres://user:pass@localhost:5432/dbname
EOL"

# Tooling config
run "cat > pyproject.toml << 'EOL'
[tool.black]
line-length = 88
target-version = ['py312']

[tool.isort]
profile = 'black'
line_length = 88
EOL"

run "cat > .flake8 << 'EOL'
[flake8]
max-line-length = 88
extend-ignore = E203, W503
exclude = .git,__pycache__,.env,.venv
EOL"

run "cat > pyrightconfig.json << 'EOL'
{
  \"pythonVersion\": \"3.13\",
  \"pythonPlatform\": \"Linux\",
  \"typeCheckingMode\": \"standard\",
  \"reportUnknownMemberType\": false,
  \"reportUnknownVariableType\": false,
  \"useLibraryCodeForTypes\": true,
  \"venvPath\": \".\",
  \"venv\": \".venv\",
  \"exclude\": [
    \"**/migrations\",
    \"**/__pycache__\",
    \"backup\",
    \"logs\",
    \"server.conf\",
    \"scripts\"
  ]
}
EOL"

run "cat > mypy.ini << 'EOL'
[mypy]
python_version = 3.12
plugins = mypy_django_plugin.main
ignore_missing_imports = true

[mypy.plugins.django-stubs]
django_settings_module = workspace.settings
EOL"

run "cat > README.md << 'EOL'
# Welcome to your Next Awesome Django Project

## Development Tips

1. Always change directory to the \`workspace\` folder.
2. Always activate the python virtual environment by run this command once:

   \`source ../.venv/bin/activate\`

3. Use the \`manage\` command to run everything that \`python3 manage.py\` did.
   Also, use the \`manage\` command to run pip installation, eg: \`manage pip install some-python-package\`
   ✅ By using that, you'll have a command forensic which you can review at \`logs/bash_history.log\`

4. In order to make LSP-pyright more intelligent, adjust this file: workspace/workspace/settings.py
   a) add these lines in the import declaration:

   \`\`\`
      import django_stubs_ext
      django_stubs_ext.monkeypatch()
   \`\`\`

   b) in \`INSTALLED_APPS\` ⇒ add: \`\"django_stubs_ext\" \`
   
5. ⚠️ If you plan to use a custom User model, define it BEFORE the first migrate.

EOL"

# Git init
run "git init"
run "git add .gitignore workspace/.gitignore"
run "git commit -m '[init] commit & .gitignore'"
run "git add pyrightconfig.json pyproject.toml .flake8 mypy.ini"
run "git commit -m '[init] python tooling config (black, isort, flake8 and LSP pyright)'"
run "git add ."
run "git commit -m '[init] django project structure'"
echo "✅ Django project initialized successfully."

if [[ "$DRY_RUN" == false ]]; then
    echo "======================================================================" >> "$LOG_FILE"
    echo "✅ Django project initialized successfully." >> "$LOG_FILE"
    echo "======================================================================" >> "$LOG_FILE"
    echo "" >> "$LOG_FILE"
    echo ""
    echo "================================================================================"
    echo "NEXT STEPS, execute these command below inside your newly created '$TARGET_DIR' directory"
    echo "================================================================================"
    echo ""
    echo "  cd workspaces"
    echo "  source ../.venv/bin/activate"
    echo "  manage git remote add origin <your git repository address>"
    echo "  manage git push"
    echo ""
    echo "================================================================================"
    echo "AND now you are ready to craft your awesome Django application! ❤️"
    echo "================================================================================"    
    echo ""
   
cat README.md
 
fi


