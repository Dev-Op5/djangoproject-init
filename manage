#!/usr/bin/env bash
set -u  # manually handled the exit code

# =================================================================
# manage — unified command wrapper with audit logging
# for Django development project initiated by djangoproject-init
# 
# scripted with ❤️ by eRQee (q@serverq.org)
# =================================================================

SCRIPT_PATH="$(realpath "$0")"
VENV_BIN="$(dirname "$SCRIPT_PATH")"
VENV_ROOT="$(realpath "$VENV_BIN/..")"
ROOT_REPO="$(realpath "$VENV_ROOT/..")"
SRC_DIR="$ROOT_REPO/src"

VENV_PYTHON="$VENV_BIN/python"
VENV_PIP="$VENV_BIN/pip"

# ---------------------------------------------------------
# sanity checks
# ---------------------------------------------------------
if [[ ! -x "$VENV_PYTHON" ]]; then
    echo "❌ Python binary not found in virtualenv"
    exit 1
fi

if [[ ! -d "$SRC_DIR" || ! -f "$SRC_DIR/manage.py" ]]; then
    echo "❌ invalid project structure."
    echo "   Expected: $SRC_DIR/manage.py"
    exit 1
fi

# CWD harus berada di dalam ROOT_REPO
CWD="$(realpath "$PWD")"
case "$CWD" in
    "$ROOT_REPO"/*) ;;
    "$ROOT_REPO") ;;
    *)
        echo "❌ the 'manage' command cannot be run from outside the project scope."
        echo "   Root project: $ROOT_REPO"
        exit 1
        ;;
esac

# ---------------------------------------------------------
# logging
# ---------------------------------------------------------
LOG_FILE="$ROOT_REPO/logs/bash_history.log"
mkdir -p "$(dirname "$LOG_FILE")"

TIMESTAMP="$(date '+%Y-%m-%d %H:%M:%S')"
FULL_CMD="manage $*"
EXIT_CODE=0
GIT_STATE=""

# warning jika venv belum aktif
if [[ -z "${VIRTUAL_ENV:-}" ]]; then
    echo "⚠️  Virtualenv is inactive (VIRTUAL_ENV not detected)"
    echo "   Command will still executed via .venv"
fi

# util: cek working tree git
git_working_tree_state() {
    if git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
        if git diff-index --quiet HEAD -- 2>/dev/null; then
            echo "GIT:CLEAN"
        else
            echo "GIT:DIRTY"
        fi
    else
        echo "GIT:N/A"
    fi
}

# ---------------------------------------------------------
# command dispatch
# ---------------------------------------------------------
SUBCOMMAND="${1:-}"
ORIGINAL_CWD="$PWD"

case "$SUBCOMMAND" in
		toc)
		    cat << 'EOF'
manage — django command gateway for artisan
================================ : scripted with ❤️ by eRQee (q@serverq.org)

Inspector commands:
  manage toc            Show this table of contents
  manage tree           Showw project directory structure
  manage history        Show the audit log (default: 20 lines)
  manage history 200    Show the 200 lines of audit log

Pass-through commands:
  manage git <args>     Run git commands in repo scope
  manage pip <args>     Run pip using project virtualenv

Django commands:
  manage runserver
  manage migrate
  manage makemigrations
  manage createsuperuser
  manage shell
  ...and all standard Django manage.py commands

Notes:
- Django commands are always executed from the 'src/' directory
- git and pip commands are executed from current working directory
- all commands are audited in logs/bash_history.log
EOF
		    EXIT_CODE=0
		    ;;

		history)
				shift

				DEFAULT_LINES=20
				LINES="$DEFAULT_LINES"

				if [[ $# -ge 1 ]]; then
				    if [[ "$1" =~ ^[0-9]+$ ]]; then
				        LINES="$1"
				    else
				        echo "❌ invalid parameter: $1"
				        echo "   usage: manage history [number_of_lines]"
				        EXIT_CODE=1
				        break
				    fi
				fi

				if [[ ! -f "$LOG_FILE" ]]; then
				    echo "❌ history log not found: $LOG_FILE"
				    EXIT_CODE=1
				    break
				fi

				tail -n "$LINES" "$LOG_FILE"
				EXIT_CODE=$?
				;;

    git)
        shift
        git "$@"
        EXIT_CODE=$?
        ;;
    pip)
        shift
        "$VENV_PIP" "$@"
        EXIT_CODE=$?
        ;;
    tree)
    		if ! command -v tree >/dev/null 2>&1; then
		      echo "❌ 'tree' command not found"
		      echo "   install it first by run: sudo apt install tree"
		      EXIT_CODE=1
		    else
		      tree "$ROOT_REPO"
		      EXIT_CODE=$?
		    fi
        ;;
    *)
        cd "$SRC_DIR"
        "$VENV_PYTHON" manage.py "$@"
        EXIT_CODE=$?
        cd "$ORIGINAL_CWD"
        ;;
esac

# ---------------------------------------------------------
# audit logging
# ---------------------------------------------------------
if [[ $EXIT_CODE -eq 0 ]]; then
    echo "[$TIMESTAMP] [OK]   $FULL_CMD" >> "$LOG_FILE"
else
    if [[ "$SUBCOMMAND" == "git" || "$SUBCOMMAND" == "pip" ]]; then
        GIT_STATE="$(git_working_tree_state)"
        echo "[$TIMESTAMP] [FAIL:$EXIT_CODE] [$GIT_STATE] $FULL_CMD" >> "$LOG_FILE"
    else
        echo "[$TIMESTAMP] [FAIL:$EXIT_CODE] $FULL_CMD" >> "$LOG_FILE"
    fi
fi

exit $EXIT_CODE

